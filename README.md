# MLPLC

Modular Low-level Programmable Logic Controller.

Программный фреймворк и набор модульных устройств для создания типовых embedded проектов.

Проект обеспечивает:
- простое, безопасное и производительное программирование бизнес-логики, минимум технического кода;
- сборку одного и того же исходного кода под разные устройства;
- проверенную **аппаратурную базу** с типовыми интерфейсами управления, портами для подключения проект-специфичных расширений;
- защищенное обновление прошивки по имеющимся интерфейсам.

## Обоснование разработки и назначение

В большинстве маленьких и средних embedded проектах бОльшая часть кода - это **технический** код: работа с аппаратными ресурсами микроконтроллера, подключение/написание middle-wire библиотек для работы с интерфейсами, файловой системой, внешними чипами.  
Бизнес-логика проекта, как правило, наоборот сравнительно проста - реагирование на входные сигналы, сбор, обработка и отправка данных с датчиков, управление выходными сигналами через upstream интерфейсы.  
Соответственно, требования к аппаратной части проекта однотипны: цифровые порты ввода/вывода, аналоговые порты ввода/вывода, счетчики импульсов, цифровые интерфейсы датчиков и других чипов - **UART**, **I2C**, **SPI**, upstream интерфейсы управления - **RS485**, **ETHERNET**.  
Поэтому, бОльшая часть ошибок сосредотачивается именно в **технической** части проекта, которая в большинстве случаев однотипна.

Данный проект призван сократить количество ошибок и снизить порог входа при разработке устройства путем включения в себя общей, типовой части embedded проекта и гарантируя её работоспособность.

## Дизайн

### Аппаратная часть

С точки зрения аппаратуры данный проект - это **база**, **аппаратная база**: микроконтроллер и обвязка, upstream интерфейсы, опционально какой-либо вид user-интерфейса. Фактически **база** будет выполнена в виде отдельной платы, к которой можно подключать платы **физики** - проект-специфичные платы, где будут расположены непосредственно силовые порты/сенсоры. Конкретный функционал плат см: набор плат [баз](board-base), набор плат [физики](board-phy).

Структурная схема:

![doc/mlplc_structure.png](doc/mlplc_structure.png)

*__У конкретных моделей базовой платы набор интерфейсов может отличаться__*

### Программный фреймворк

На данный момент существуют фреймворки для обеспечения универсального высокоуровневого доступа к периферии микроконтроллера: `mbed-os`, `zephyr-os` и другие, для данного проекта взят за основу [zephyr](https://github.com/zephyrproject-rtos/zephyr), потому что он обеспечивает наиболее полный доступ к периферии и активно развивается.

Но, тем не менее, за счет своей универсальности `zephyr` имеет достаточно громоздкий интерфейс, поэтому, в рамках данного проекта разработан простой `modern-safe-c++` API к `zephyr` с учетом типовых embedded потребностей.  

Данный проект требует `board support package`(`BSP`) для каждой **базы**, который включает в себя маппинг аппаратуры - `.dts.overlay` файлы, платформно-зависимый код.

Также в embedded проектах требуются типовые, как правило кросс-платформенные утилиты и алгоритмы, например: текстовое меню, библиотеки обработки сигналов и др. Эти библиотеки включаются во фреймворк как `utils`.

![doc/mlplc_framework.png](doc/mlplc_framework.png)

#### MLPLC Framework API

||||
|---|---|---|
|  |  |  |

## Use-case

### Измеритель переменного тока и напряжения

3-х фазный измеритель тока и напряжения(4 сенсора тока, 3 сенсора напряжения).  
Максимальный измеряемый ток 25А.  
Погрешность измерения тока +-10mA.  
Непрерывное измерение с частотой дискретизации 10кГц для расчета потребления мощности и отправки выборок на сервер для более детального анализа.  
Длина непрерывной выборки для отправки на сервер - 20 периодов или 4000 точек(суммарно с 7-ми каналов 28к точек или 56кБ).

Требования к базовой плате:
|RAM для бизнес-логики|Upstream интерфейсы|User интерфейсы|Порт физики|
|---|---|---|---|
|200KB|Modbus-RTU для снятие показаний<br><br>Ethernet для отправки выборок|Display-Button меню для отображения показаний и настройки|7 дифференциальных каналов АЦП разрядностью 13+ эффективных бит<br><br>Возможность считывать коэффициенты калибровки с платы физики<br><br>Возможность получать питание с платы физики|

### Контроллер АВД

Блок управления насосным оборудованием высокого давления. Расчитан на подключение до 4 клапанов и до 2 дозирующих насосов ULKA.
Питание от переменного тока AC 24В 50Гц, изменение состояний при переходе через ноль. Дозация с дискретностью 1 период сети (20мс).
Настройки и счетчик моточасов с доступом через меню и через файл конфигурации.
4 дискретных входа и 2 выхода.

Требования к базовой плате:
|RAM для бизнес-логики|Upstream интерфейсы|User интерфейсы|Порт физики|
|---|---|---|---|
|- КВ|Modbus-RTU для управления|Display-Button меню для отображения показаний и настройки|4 дискретных входа, 2 выхода <br> 4 выхода для подключения катушки AC 24V 10W <br> 2 выхода для управления ULKA AC 24V 60W |

### Вендинговый контроллер

Контроллер для организации приема платежей и оказания услуг/выдачи товаров. Включает поддержку самых распространенных интерфейсов платежных устройств (Pulse, MDB, CCTalk), взаимодействие с другими устройствами по ModBus RTU, TCP, дискретные входы и выходы, работа с дисплеем и кнопками. Базовые настройки через меню, файл конфигурации во внутренней памяти.

Требования к базовой плате:
|RAM для бизнес-логики|Upstream интерфейсы|User интерфейсы|Порт физики|
|---|---|---|---|
|- KB|Modbus-RTU master<br><br>Ethernet для TCP/UDP|Display-Button меню|Аппаратная поддержка Pulse+inh, MDB, CCTalk<br> serial port для периферии <br> i2c порт для периферии|

## Get started


